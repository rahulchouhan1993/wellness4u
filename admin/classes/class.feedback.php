<?phpinclude_once("class.paging.php");include_once("class.admin.php");class Feedback extends Admin{	//update by AMPLE 18-04-20	public function GetAllPages()	{		        $my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();				$arr_feedback_id = $this->GetAllFeedback();         		if(count($arr_feedback_id) > 0)		{        			$str_feedback_id = implode(',',$arr_feedback_id);			$admin_id = $_SESSION['admin_id'];			$reply_action_id = '111';			$delete_action_id = '112';			$reply = $this->chkValidActionPermission($admin_id,$reply_action_id);			$delete = $this->chkValidActionPermission($admin_id,$delete_action_id);			$sql = "SELECT TA.feedback_id,TA.name,TA.feedback,TA.feedback_add_date,TA.user_id,TA.is_vendor,TS.page_name,TA.status FROM `tblfeedback` AS TA					LEFT JOIN tblpages AS TS ON TA.page_id = TS.page_id						WHERE `parent_feedback_id` = '0' AND `admin` = '0'					ORDER BY feedback_add_date DESC";			//echo $sql;						$STH = $DBH->prepare($sql);                   $STH->execute();			$total_records=$STH->rowCount();			$record_per_page=100;			$scroll=5;			$page=new Page(); 			$page->set_page_data($_SERVER['PHP_SELF'],$total_records,$record_per_page,$scroll,true,true,true);			$page->set_link_parameter("Class = paging");			$page->set_qry_string($str="mode=feedback");			//$result=$this->execute_query($page->get_limit_query($sql));                      $STH2 = $DBH->prepare($page->get_limit_query($sql));                      $STH2->execute();			$output = '';					if($STH2->rowCount() > 0)			{				if( isset($_GET['page']) && is_numeric($_GET['page']) && $_GET['page'] > 0 )				{					$i = $page->start + 1;				}				else				{					$i = 1;				}				while($row = $STH2->fetch(PDO::FETCH_ASSOC))				{					if($row['status'] == 1)						{							 $status = 'Active'; 						}						else						{ 							$status = 'Inactive';						}										if($row['page_name'] == '')						{							 $page_name = 'General'; 						}						else						{ 							$page_name = $row['page_name'];						}						//add by ample 18-04-20						if($row['is_vendor']=='1')						{							$unique_id=$this->get_vendor_uniqID($row['user_id']);						}						else 						{							$unique_id=$this->get_user_uniqID($row['user_id']);						}												$day = $row['feedback_add_date'];						//$date = date('d-M-Y h:i A',strtotime($day));						$time= strtotime($day);						$time=$time+19800;						$date = date('d-M-Y h:i A',$time);						//echo $date->format('d-M-Y h:i A');					$output .= '<tr class="manage-row">';					$output .= '<td height="30"  align="center" nowrap="nowrap" >'.$i.'</td>';					$output .= '<td height="30" align="center"><a title="click here to view conversations" href="index.php?mode=view_conversation&uid='.$row['feedback_id'].'">'.stripslashes($row['name']).'</a></td>';					$output .= '<td height="30" align="center">'.$unique_id.'</td>';					$output .= '<td height="30" align="center">'.$page_name.'</td>';					$output .= '<td height="30" align="center">'.stripslashes($row['feedback']).'</td>';					$output .= '<td height="30" align="center">'.$date.'</td>';					$output .= '<td height="30" align="center">'.$status.'</td>';					$output .= '<td height="30" align="center" nowrap="nowrap">';												$output .= '<input type="checkbox" id="chk_status" name="chk_status[]" value="'.$row['feedback_id'].'" />';					$output .= '</td>';					$output .= '</tr>';					$i++;				}			}			else			{				$output = '<tr class="manage-row" height="20"><td colspan="7" align="center">NO RECORDS FOUND</td></tr>';			}						$page->get_page_nav();		}		else		{			$output = '<tr class="manage-row" height="20"><td colspan="7" align="center">NO RECORDS FOUND</td></tr>';		}			return $output;	}	public	function ActiveFeedback($active_status)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();                $return = false;		$sql = "UPDATE `tblfeedback` SET `status` = '1'  WHERE `feedback_id` = '".$active_status."'"; 		//echo $sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{			$return = true;		}		return $return;	}		public	function InActiveFeedback($active_status)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();		$return = false;		$sql = "UPDATE `tblfeedback` SET `status` = '0'  WHERE `feedback_id` = '".$active_status."'"; 		//echo $sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{			$return = true;		}		return $return;	}public function GetAllFeedBackByID($id)  {  	        $my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();	$arr_feedback_id  = array();	$arr_feedback  = array();	$arr_name  = array(); 	$arr_feedback_add_date  = array();	$arr_admin  = array();	$arr_status = array();	$sql = "SELECT * FROM `tblfeedback` WHERE  `feedback_id` IN (".$id.") ORDER BY `feedback_add_date` DESC";	//echo "<br>Testkk GetAllFeedBackByID sql = ".$sql;				$STH = $DBH->prepare($sql);        $STH->execute();	if($STH->rowCount() > 0)		{		while($row = $STH->fetch(PDO::FETCH_ASSOC))			{				array_push($arr_feedback_id , $row['feedback_id']);				array_push($arr_feedback , $row['feedback']);				array_push($arr_name , $row['name']);				array_push($arr_feedback_add_date , $row['feedback_add_date']);				array_push($arr_admin , $row['admin']);				array_push($arr_status , $row['status']);			}		}	return array($arr_feedback_id,$arr_feedback,$arr_name,$arr_feedback_add_date,$arr_admin,$arr_status);}		 public function getLatestFeedBackID($id)  {  	       $my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();		$sql = "SELECT * FROM `tblfeedback` WHERE `parent_feedback_id` = '".$id."' AND `admin` = '0' ORDER BY `feedback_add_date` DESC";   // echo"<br>Testkk: getLatestFeedBackID sql = ".$sql;	$STH = $DBH->prepare($sql);        $STH->execute();	if($STH->rowCount() > 0)		{			$row = $STH->fetch(PDO::FETCH_ASSOC);			$id2 = stripslashes($row['feedback_id']);			return $this->getLatestFeedBackID($id2);		}		else		{			return $id;		}	  }	public function get_parent_id($id)  	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();		$parent_id = '0';		$sql = "SELECT * FROM `tblfeedback` WHERE `feedback_id` = '".$id."' ORDER BY `feedback_add_date` DESC";				$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)			{				$row = $STH->fetch(PDO::FETCH_ASSOC);				$parent_id = $row['parent_feedback_id'];			}			if($parent_id == 0)			{				$parent_id = $id;			}								return $parent_id;	}  	public function getLatestConvesationID($id)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();				$sql = "SELECT * FROM `tblfeedback` WHERE `feedback_id` = '".$id."' ORDER BY `feedback_add_date` DESC";		//echo "<br>Testkk sql1111 ".$sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{				$row = $STH->fetch(PDO::FETCH_ASSOC);			$parent_feedback_id = $row['parent_feedback_id'];			if($parent_feedback_id > 0)			{				return $id.','.$this->getLatestConvesationID($parent_feedback_id);					}			else			{				return $id;			}			}	}	public function GetAllConvarsation($id)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();					$sql = "SELECT * FROM `tblfeedback` WHERE `feedback_id` = '".$id."' ORDER BY `feedback_add_date` DESC";				//echo "<br>Testkk sql = ".$sql;				$STH = $DBH->prepare($sql);                                $STH->execute();				if($STH->rowCount() > 0)					{							$row = $STH->fetch(PDO::FETCH_ASSOC);						$parent_feedback_id = $row['parent_feedback_id'];														$sql2 = "SELECT * FROM `tblfeedback` WHERE `parent_feedback_id` = '".$parent_feedback_id."' AND `parent_feedback_id` != '0' ORDER BY `feedback_add_date` DESC";														//echo "<br>Testkk sql2 = ".$sql2;							$STH2 = $DBH->prepare($sql2);                                                        $STH2->execute();							if($STH2->rowCount() > 0)							{								while($row2 = $STH2->fetch(PDO::FETCH_ASSOC))								{									$feedback_id .= $row2['feedback_id'].',';								}																}										}													$str_feedback_id = $feedback_id;		//echo "<br>Testkk str_feedback_id22222222222 = ".$str_feedback_id;		$str_feedback_id .= $this->getLatestConvesationID($id);		//echo "<br>Testkk str_feedback_id = ".$str_feedback_id;		return $str_feedback_id;	}	public function GetMainParantId($id)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();				$sql = "SELECT * FROM `tblfeedback` WHERE `feedback_id` = '".$id."' ORDER BY `feedback_add_date` DESC";		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{				$row = $STH->fetch(PDO::FETCH_ASSOC);			$parent_feedback_id = $row['parent_feedback_id'];			if($parent_feedback_id == 0)			{				return $id;			}			else			{				return $this->GetMainParantId($parent_feedback_id);			}		}		else		{			return 0;		}	}	public function getRecursiveFeedbackId($main_parent_id,$return)	{		$obj1 = new Feedback();		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();                $return = false;		$sql = "SELECT * FROM `tblfeedback` WHERE `parent_feedback_id` = '".$main_parent_id."' ";		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{			while($row = $STH->fetch(PDO::FETCH_ASSOC))			{	              				$temp_feedback_id = $row['feedback_id'];  				if($return == '')				{					$return .= $obj1->getRecursiveFeedbackId($temp_feedback_id,$main_parent_id);  				}				else				{					$return .= ','.$obj1->getRecursiveFeedbackId($temp_feedback_id,$main_parent_id);				}				}		}		else		{			$return .= $main_parent_id;		}     		return $return;	}	public function GetAllConvarsationId($id)	{		$main_parent_id = $this->GetMainParantId($id);		$str_feedback_id = $this->getRecursiveFeedbackId($main_parent_id,$main_parent_id);// echo "<pre>";print_r($str_feedback_id);echo "</pre>";// exit;		return $str_feedback_id;	}	public function GetAllFeedback()	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();               				$arr_feedback_id  = array(); 		$tmp_feedback_id  = array(); 		$sql = "SELECT * FROM `tblfeedback` WHERE `admin` = '0' and `parent_feedback_id` = '0' ORDER BY `feedback_add_date` DESC";		//echo "<br>GetAllFeedback sql = ".$sql;					$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)			{			while($row = $STH->fetch(PDO::FETCH_ASSOC))				{					array_push($tmp_feedback_id , $row['feedback_id']);													}							for($i=0;$i<count($tmp_feedback_id);$i++)			{				array_push($arr_feedback_id , $this->getLatestFeedBackID($tmp_feedback_id[$i]));				}			}		return $arr_feedback_id;	}		//update by ample 16-04-20	public function Insert_admin_reply($feedback_id,$page_id,$user_id,$name,$email,$reply)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();                $return = false;		$ins_sql = "INSERT INTO `tblfeedback`(`parent_feedback_id`,`page_id`,`user_id`,`name`,`email`,`feedback`,`admin`,status) VALUES ('".addslashes($feedback_id)."','".addslashes($page_id)."','".addslashes($user_id)."','".addslashes($name)."','".addslashes($email)."','".addslashes($reply)."' ,'1','1' )";		//echo "<br>Testkk ins_sql = ".$ins_sql;		$STH = $DBH->prepare($ins_sql);                $STH->execute();		if($STH->rowCount() > 0)		{			$return = true;		}		return $return;	}		public function getfeedback($id)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();                		$page_name = '';		$feedback = '';		$status = '';		$email = '';	    $name = '';		$page_id = '';		$user_id = '';		$feedback_date = ''; // add by ample 17-04-20						$sql = "SELECT * FROM `tblfeedback` AS TA				LEFT JOIN tblpages AS TS ON TA.page_id = TS.page_id				WHERE `feedback_id` = '".$id."'";		//echo $sql;				$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{			$row = $STH->fetch(PDO::FETCH_ASSOC);			if($row['page_name'] == '')					{						 $page_name = 'General'; 					}					else					{ 						$page_name = $row['page_name'];					}						$page_name = $page_name;			$feedback = stripslashes($row['feedback']);			$status = stripslashes($row['status']);			$email = stripslashes($row['email']);			$name = stripslashes($row['name']);			$page_id = stripslashes($row['page_id']);			$user_id = stripslashes($row['user_id']);			$feedback_date = stripslashes($row['feedback_add_date']); //add by ample 17-04-20		}		//update by ample 17-04-20		return array($page_name,$feedback,$status,$email,$name,$page_id,$user_id,$feedback_date);	}			public function DeleteMainfeedback($uid)	{		$str_feedback_id = $this->GetAllConvarsationId($uid);		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();                $return = false;		$sql = "DELETE  FROM `tblfeedback` WHERE `feedback_id` IN (".$str_feedback_id.") ";		//echo $sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{			$return = true;		}		return $return;	}		public function Deletefeedback($uid)	{		$my_DBH = new mysqlConnection();                $DBH = $my_DBH->raw_handle();                $DBH->beginTransaction();                $return = false;		$sql = "DELETE  FROM `tblfeedback` WHERE `feedback_id` = '".$uid."' OR `parent_feedback_id` = '".$uid."' ";		//echo $sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{			$return = true;		}		return $return;	}	//add ample 16-04-20    public function feedback_update($feedback_id, $feedback) {        $my_DBH = new mysqlConnection();        $DBH = $my_DBH->raw_handle();        $DBH->beginTransaction();        $return = false;        $sql = "UPDATE `tblfeedback` SET `feedback` = '".$feedback."' WHERE `feedback_id` = '".$feedback_id."'";        //echo $sql;        $STH = $DBH->query($sql);        if ($STH->rowCount() > 0) {            $return = true;        }        return $return;    }    //add by ample 18-04-20    public	function get_user_uniqID($user_id)	{		$my_DBH = new mysqlConnection();        $DBH = $my_DBH->raw_handle();        $DBH->beginTransaction();        $return = false;        $data=array();		$sql = "SELECT  unique_id FROM `tblusers`  WHERE `user_id` = ".$user_id; 		//echo $sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{				$row = $STH->fetch(PDO::FETCH_ASSOC);			$return = $row['unique_id'];		}		return $return;	}	//add by ample 18-04-20	public	function get_vendor_uniqID($user_id)	{		$my_DBH = new mysqlConnection();        $DBH = $my_DBH->raw_handle();        $DBH->beginTransaction();        $return = false;        $data=array();		$sql = "SELECT vendor_unique_id FROM `tblvendors`  WHERE `vendor_id` = ".$user_id; 		//echo $sql;		$STH = $DBH->prepare($sql);                $STH->execute();		if($STH->rowCount() > 0)		{				$row = $STH->fetch(PDO::FETCH_ASSOC);			$return = $row['vendor_unique_id'];		}		return $return;	}}?>